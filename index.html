<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>thIAguinho Wii: FINAL MASTER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Russo+One&display=swap');

        /* RESET & BASE */
        body {
            background-color: #050505;
            margin: 0;
            overflow: hidden;
            font-family: 'Russo One', sans-serif;
            touch-action: none; /* Bloqueia zoom/scroll no mobile */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

        /* V√çDEO (Espelhado via CSS para conforto visual) */
        #webcam {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); 
            filter: brightness(0.6) contrast(1.2);
            z-index: 0;
        }
        
        /* O v√≠deo fonte fica oculto, usado apenas para leitura da IA */
        #video-source { display: none; }

        /* CANVAS (Onde o jogo √© desenhado) */
        #game-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        /* UI LAYERS */
        .ui-screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 50;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }
        .interactive { pointer-events: auto !important; }

        /* EST√âTICA NINTENDO/ARCADE */
        .n-badge {
            background: #e60012; color: white; padding: 5px 15px;
            border-radius: 50px; font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 1rem; letter-spacing: 1px;
        }

        .game-card {
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            border: 2px solid #333;
            box-shadow: 0 8px 0 #000;
            transition: transform 0.1s, border-color 0.2s;
        }
        .game-card:active { transform: translateY(4px); box-shadow: 0 4px 0 #000; border-color: #00ffff; }

        /* SLIDER CUSTOMIZADO */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px;
            border-radius: 50%; background: #00ffff; margin-top: -10px;
            box-shadow: 0 0 15px #00ffff; border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #555; border-radius: 2px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <video id="video-source" playsinline></video>
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="game-canvas"></canvas>

    <div id="screen-boot" class="ui-screen bg-black interactive">
        <span class="n-badge">SYSTEM READY v4.0</span>
        <h1 class="text-6xl md:text-8xl text-white font-black italic mb-2 text-center drop-shadow-lg">
            thIAguinho<br><span class="text-cyan-400">Wii U</span>
        </h1>
        <p class="text-gray-400 text-sm mb-12 font-mono tracking-widest">MOTION ENGINE MASTER</p>
        
        <button onclick="System.boot()" class="bg-gradient-to-r from-cyan-600 to-blue-600 text-white text-xl py-5 px-16 rounded-full font-bold shadow-[0_0_40px_rgba(6,182,212,0.4)] animate-pulse hover:scale-105 transition-transform">
            TOCAR PARA INICIAR
        </button>
        <div id="boot-error" class="text-red-500 mt-6 text-xs font-mono hidden bg-red-900/20 p-4 rounded border border-red-500"></div>
    </div>

    <div id="screen-loading" class="ui-screen bg-black/95 hidden">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-cyan-500/30 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h2 class="text-white text-xl font-bold tracking-widest">CALIBRANDO IA...</h2>
        <div class="text-xs text-gray-500 mt-2 font-mono" id="load-status">Carregando TensorFlow...</div>
    </div>

    <div id="screen-menu" class="ui-screen bg-black/85 hidden interactive overflow-y-auto">
        <h2 class="text-5xl text-white font-black mb-10 italic text-center drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">SELECT GAME</h2>
        
        <div class="grid grid-cols-1 gap-6 w-full max-w-sm px-6 pb-10">
            <button onclick="System.launch('drive')" class="game-card p-6 rounded-2xl flex items-center gap-6 group hover:bg-gray-800">
                <div class="text-5xl group-hover:scale-110 transition-transform">üèéÔ∏è</div>
                <div class="text-left">
                    <h3 class="text-2xl text-white font-bold group-hover:text-red-400">NEON RACER</h3>
                    <p class="text-xs text-gray-400 mt-1">Gire as m√£os como um volante real.</p>
                </div>
            </button>

            <button onclick="System.launch('run')" class="game-card p-6 rounded-2xl flex items-center gap-6 group hover:bg-gray-800">
                <div class="text-5xl group-hover:scale-110 transition-transform">üèÉ</div>
                <div class="text-left">
                    <h3 class="text-2xl text-white font-bold group-hover:text-green-400">TURBO RUN</h3>
                    <p class="text-xs text-gray-400 mt-1">Corra e incline o corpo (F√≠sica Corrigida).</p>
                </div>
            </button>

            <button onclick="System.launch('fight')" class="game-card p-6 rounded-2xl flex items-center gap-6 group hover:bg-gray-800">
                <div class="text-5xl group-hover:scale-110 transition-transform">ü•ä</div>
                <div class="text-left">
                    <h3 class="text-2xl text-white font-bold group-hover:text-purple-400">GYM BOXING</h3>
                    <p class="text-xs text-gray-400 mt-1">Esqueleto visual + Hitbox precisa.</p>
                </div>
            </button>
        </div>
        
        <div class="fixed bottom-4 text-center w-full opacity-50">
            <p class="text-[10px] text-cyan-400 font-mono uppercase">Desenvolvido com ü§ñ por thIAguinho Solu√ß√µes</p>
        </div>
    </div>

    <div id="screen-hud" class="ui-screen hidden justify-between p-4 pointer-events-none">
        <div class="w-full flex justify-between items-start">
            <div class="bg-black/60 backdrop-blur-md px-6 py-2 rounded-full border border-white/20 shadow-lg">
                <div class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase">Score</div>
                <div id="hud-score" class="text-4xl text-white font-mono leading-none">00000</div>
            </div>
            
            <button onclick="System.quit()" class="interactive bg-red-600 hover:bg-red-500 text-white w-12 h-12 rounded-full font-bold shadow-lg border-2 border-red-300 flex items-center justify-center text-xl transition-transform hover:rotate-90">
                ‚úï
            </button>
        </div>

        <div id="game-msg" class="absolute top-1/4 w-full text-center pointer-events-none"></div>

        <div id="hud-wheel" class="absolute bottom-24 left-1/2 transform -translate-x-1/2 opacity-0 transition-opacity duration-300">
            <div class="w-24 h-24 rounded-full border-4 border-cyan-500/50 flex items-center justify-center relative">
                <div id="wheel-indicator" class="w-full h-1 bg-cyan-400/80"></div>
                <div class="absolute top-0 w-2 h-4 bg-red-500"></div>
            </div>
        </div>

        <div class="interactive absolute bottom-6 right-6 bg-black/60 p-4 rounded-xl backdrop-blur border border-white/10 shadow-xl">
            <label class="text-[10px] text-gray-300 block mb-2 text-center font-bold tracking-widest">SENSIBILIDADE</label>
            <input type="range" min="0.5" max="3.0" step="0.5" value="1.0" class="w-32 accent-cyan-400" oninput="System.setSens(this.value)">
            <div class="flex justify-between text-[8px] text-gray-500 mt-1">
                <span>SUAVE</span>
                <span>R√ÅPIDO</span>
            </div>
        </div>
    </div>

    <div id="screen-over" class="ui-screen bg-red-900/95 hidden interactive z-50">
        <h1 class="text-6xl text-white font-black italic mb-2 drop-shadow-lg">GAME OVER</h1>
        <div class="bg-black/30 p-8 rounded-3xl border-2 border-red-400/50 mb-10 backdrop-blur-sm text-center">
            <p class="text-xs text-red-200 uppercase tracking-widest mb-2">Pontua√ß√£o Final</p>
            <div class="text-7xl text-yellow-400 font-mono font-bold" id="final-score">0</div>
        </div>
        <button onclick="System.menu()" class="bg-white text-red-900 py-4 px-12 rounded-full font-bold hover:scale-105 transition-transform shadow-2xl uppercase tracking-widest">
            Voltar ao Menu
        </button>
    </div>
</div>

<script>
    /**
     * =================================================================
     * üîä AUDIO ENGINE (Sintetizador WebAudio API)
     * Gera sons matematicamente. N√£o requer internet nem arquivos.
     * =================================================================
     */
    const Sfx = {
        ctx: null,
        init: () => {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            Sfx.ctx = new AudioContext();
        },
        play: (freq, type, duration, vol=0.1, slide=0) => {
            if(!Sfx.ctx) return;
            const osc = Sfx.ctx.createOscillator();
            const gain = Sfx.ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, Sfx.ctx.currentTime);
            if(slide !== 0) {
                osc.frequency.exponentialRampToValueAtTime(freq + slide, Sfx.ctx.currentTime + duration);
            }
            
            gain.gain.setValueAtTime(vol, Sfx.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, Sfx.ctx.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(Sfx.ctx.destination);
            
            osc.start();
            osc.stop(Sfx.ctx.currentTime + duration);
        },
        // Presets de Som
        coin: () => { Sfx.play(1200, 'sine', 0.1, 0.1); setTimeout(()=>Sfx.play(1800, 'sine', 0.2, 0.1), 50); },
        crash: () => { Sfx.play(150, 'sawtooth', 0.4, 0.3, -100); },
        engine: (rpm) => { /* Som de motor complexo omitido para performance */ },
        hit: () => { Sfx.play(200, 'square', 0.1, 0.1, -100); },
        whoosh: () => { Sfx.play(300, 'triangle', 0.2, 0.05, -200); }
    };

    /**
     * =================================================================
     * üé® GRAPHICS ENGINE (Desenho e Efeitos)
     * =================================================================
     */
    const Gfx = {
        // Desenha o Esqueleto AR sobre o v√≠deo
        drawSkeleton: (ctx, pose, w, h) => {
            if(!pose) return;
            const p = pose.keypoints;
            const find = n => p.find(k=>k.name===n);
            
            // MAP MODE: Video (640) -> Tela (W) Espelhada
            // Se o v√≠deo √© 640px de largura e rawX √© 100 (esquerda):
            // Na tela espelhada, isso deve ser desenhado na direita.
            // Formula: x = w - (rawX / 640 * w)
            const mapX = x => w - (x / 640 * w);
            const mapY = y => (y / 480 * h);

            const connections = [
                ['left_shoulder', 'right_shoulder'],
                ['left_shoulder', 'left_elbow'], ['left_elbow', 'left_wrist'],
                ['right_shoulder', 'right_elbow'], ['right_elbow', 'right_wrist']
            ];

            ctx.lineCap = 'round'; ctx.lineJoin = 'round';

            // Ossos (Brilho Neon)
            ctx.shadowBlur = 10; ctx.shadowColor = '#00ffff';
            ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 4;
            
            connections.forEach(pair => {
                const p1 = find(pair[0]);
                const p2 = find(pair[1]);
                if(p1 && p2 && p1.score > 0.3 && p2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(mapX(p1.x), mapY(p1.y));
                    ctx.lineTo(mapX(p2.x), mapY(p2.y));
                    ctx.stroke();
                }
            });

            // Juntas (Pontos Brancos)
            ctx.fillStyle = '#fff'; ctx.shadowBlur = 0;
            ['left_wrist', 'right_wrist', 'nose'].forEach(n => {
                const pt = find(n);
                if(pt && pt.score > 0.3) {
                    ctx.beginPath();
                    ctx.arc(mapX(pt.x), mapY(pt.y), 8, 0, Math.PI*2);
                    ctx.fill();
                }
            });
        },

        drawFerrari: (ctx, x, y, angle) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(1.5, 1.5);
            ctx.rotate(angle); // Rota√ß√£o suave do carro
            
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.beginPath(); ctx.ellipse(0, 5, 45, 20, 0, 0, Math.PI*2); ctx.fill();

            // Chassi
            const grad = ctx.createLinearGradient(-30,0,30,0);
            grad.addColorStop(0, '#cc0000'); grad.addColorStop(0.5, '#ff3333'); grad.addColorStop(1, '#cc0000');
            ctx.fillStyle = grad;
            
            ctx.beginPath();
            ctx.moveTo(-32, 18); ctx.lineTo(-28, -10); // Traseira
            ctx.quadraticCurveTo(0, -18, 28, -10); // Nariz Curvo
            ctx.lineTo(32, 18); // Frente
            ctx.closePath(); ctx.fill();

            // Vidro
            ctx.fillStyle = '#111';
            ctx.beginPath(); ctx.moveTo(-18,-5); ctx.lineTo(-14,-14); ctx.lineTo(14,-14); ctx.lineTo(18,-5); ctx.fill();

            // Luzes
            ctx.fillStyle = '#ffff00'; // Farol
            ctx.beginPath(); ctx.arc(-25, 15, 2, 0, Math.PI*2); ctx.arc(25, 15, 2, 0, Math.PI*2); ctx.fill();
            
            ctx.restore();
        },

        drawRunner: (ctx, x, y, frame) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(2, 2);
            ctx.strokeStyle = '#0f0'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.shadowColor='#0f0'; ctx.shadowBlur=10;

            const s = Math.sin(frame * 0.4) * 12; // Ciclo de corrida
            const bounce = Math.abs(Math.cos(frame * 0.4)) * 5;

            // Tronco
            ctx.beginPath(); ctx.moveTo(0, 0-bounce); ctx.lineTo(4, -22-bounce); ctx.stroke();
            // Pernas
            ctx.beginPath(); ctx.moveTo(0, 0-bounce); ctx.lineTo(-12+s, 20-bounce); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, 0-bounce); ctx.lineTo(12-s, 20-bounce); ctx.stroke();
            // Bra√ßos
            ctx.beginPath(); ctx.moveTo(4, -20-bounce); ctx.lineTo(-12-s, -10-bounce); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(4, -20-bounce); ctx.lineTo(20+s, -10-bounce); ctx.stroke();
            // Cabe√ßa
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(4, -28-bounce, 5, 0, Math.PI*2); ctx.fill();
            
            ctx.restore();
        }
    };

    /**
     * =================================================================
     * üß† SYSTEM CORE (Gerenciador de Estado)
     * =================================================================
     */
    const System = {
        video: document.getElementById('video-source'),
        canvas: document.getElementById('game-canvas'),
        ctx: document.getElementById('game-canvas').getContext('2d'),
        detector: null,
        active: false,
        mode: null,
        sens: 1.0,
        loopId: null,

        boot: async () => {
            document.getElementById('screen-boot').classList.add('hidden');
            document.getElementById('screen-loading').classList.remove('hidden');
            
            // Inicia AudioContext no clique (Gest√£o de energia Mobile)
            Sfx.init(); 
            Sfx.coin(); // Teste de som

            try {
                // 1. Acesso √† C√¢mera
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: {ideal: 640}, height: {ideal: 480} },
                    audio: false
                });
                System.video.srcObject = stream;
                document.getElementById('webcam').srcObject = stream;
                
                await new Promise(r => System.video.onloadedmetadata = r);
                System.video.play();
                document.getElementById('webcam').play();

                // 2. Carregar Modelo IA
                await tf.setBackend('webgl');
                System.detector = await poseDetection.createDetector(
                    poseDetection.SupportedModels.MoveNet,
                    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
                );

                // 3. Sucesso
                document.getElementById('screen-loading').classList.add('hidden');
                System.menu();

            } catch(e) {
                document.getElementById('boot-error').innerText = "ERRO: Permiss√£o de c√¢mera negada ou dispositivo incompat√≠vel.\n" + e.message;
                document.getElementById('boot-error').classList.remove('hidden');
                document.getElementById('screen-boot').classList.remove('hidden');
                document.getElementById('screen-loading').classList.add('hidden');
            }
        },

        launch: (m) => {
            System.mode = m;
            System.active = true;
            
            // Inicia L√≥gica Espec√≠fica
            if(m === 'drive') Logic.Drive.init();
            if(m === 'run') Logic.Run.init();
            if(m === 'fight') Logic.Fight.init();

            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-hud').classList.remove('hidden');

            // Feedback Visual Espec√≠fico
            const wheel = document.getElementById('hud-wheel');
            if(m === 'drive') { wheel.style.opacity = '1'; } 
            else { wheel.style.opacity = '0'; }

            System.loop();
        },

        menu: () => {
            document.getElementById('screen-hud').classList.add('hidden');
            document.getElementById('screen-over').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
            System.ctx.clearRect(0,0,System.canvas.width, System.canvas.height);
        },

        quit: () => {
            System.active = false;
            cancelAnimationFrame(System.loopId);
            System.menu();
        },

        setSens: (v) => { 
            System.sens = parseFloat(v); 
            System.msg(`SENS: ${v}x`);
        },

        msg: (txt) => {
            const el = document.getElementById('game-msg');
            el.innerHTML = `<h1 class="text-4xl text-yellow-400 font-black drop-shadow-[0_4px_0_#000] animate-bounce">${txt}</h1>`;
            setTimeout(()=>el.innerHTML='', 1500);
        },

        gameOver: (score) => {
            System.active = false;
            cancelAnimationFrame(System.loopId);
            Sfx.crash();
            document.getElementById('final-score').innerText = score;
            document.getElementById('screen-hud').classList.add('hidden');
            document.getElementById('screen-over').classList.remove('hidden');
        },

        loop: async () => {
            if(!System.active) return;

            // Responsividade Canvas
            if(System.canvas.width !== window.innerWidth) {
                System.canvas.width = window.innerWidth;
                System.canvas.height = window.innerHeight;
            }

            const ctx = System.ctx;
            const w = System.canvas.width;
            const h = System.canvas.height;

            // Detec√ß√£o IA
            let pose = null;
            try {
                // flipHorizontal: false pois tratamos espelhamento na l√≥gica visual
                const poses = await System.detector.estimatePoses(System.video, {flipHorizontal: false});
                if(poses.length > 0) pose = poses[0];
            } catch(e){}

            // Update L√≥gica Jogo
            let score = 0;
            if(System.mode === 'drive') score = Logic.Drive.update(ctx, w, h, pose);
            if(System.mode === 'run') score = Logic.Run.update(ctx, w, h, pose);
            if(System.mode === 'fight') score = Logic.Fight.update(ctx, w, h, pose);

            document.getElementById('hud-score').innerText = score.toString().padStart(5, '0');
            System.loopId = requestAnimationFrame(System.loop);
        }
    };

    /**
     * =================================================================
     * üéÆ LOGIC ENGINE (F√≠sica e Regras)
     * =================================================================
     */
    const Logic = {
        
        // --- JOGO 1: CARRO (Corre√ß√£o de √Çngulo) ---
        Drive: {
            x: 0, speed: 0, road: 0, curve: 0, smoothSteer: 0,
            init: () => { Logic.Drive.x=0; Logic.Drive.speed=0; System.msg("SEGURE O VOLANTE"); },
            update: (ctx, w, h, pose) => {
                const d = Logic.Drive;
                const cx = w/2;

                // 1. INPUT
                let targetAngle = 0;
                if(pose) {
                    const lw = pose.keypoints.find(k=>k.name==='left_wrist');
                    const rw = pose.keypoints.find(k=>k.name==='right_wrist');
                    
                    if(lw.score > 0.3 && rw.score > 0.3) {
                        // Math.atan2 calcula o √¢ngulo exato em radianos entre os pulsos
                        const dy = rw.y - lw.y;
                        const dx = rw.x - lw.x;
                        const radians = Math.atan2(dy, dx);
                        
                        // Fator de corre√ß√£o para volante (Sensibilidade)
                        targetAngle = radians * 1.5 * System.sens;

                        if(d.speed < 120) d.speed += 1.5;
                    } else {
                        if(d.speed > 0) d.speed -= 1;
                    }
                }

                // Suaviza√ß√£o (Lerp) para remover tremedeira
                d.smoothSteer += (targetAngle - d.smoothSteer) * 0.1;

                // Atualiza HUD Volante
                const wheelEl = document.getElementById('wheel-indicator');
                if(wheelEl) wheelEl.style.transform = `rotate(${d.smoothSteer * 40}deg)`;

                // 2. F√çSICA
                d.road += d.speed;
                // Gerador de Pista
                if(d.road > 2000) { d.tgtCurve = (Math.random()-0.5)*3; d.road=0; }
                d.curve += ((d.tgtCurve||0) - d.curve) * 0.01;

                // Movimento do Carro
                d.x += d.smoothSteer * (d.speed/800); 
                d.x -= d.curve * (d.speed/2000); // For√ßa centr√≠fuga

                if(Math.abs(d.x) > 1.3) { d.speed *= 0.9; } // Grama

                // 3. RENDER
                ctx.clearRect(0,0,w,h);
                // C√©u
                const grad = ctx.createLinearGradient(0,0,0,h/2);
                grad.addColorStop(0, '#000022'); grad.addColorStop(1, '#440022');
                ctx.fillStyle = grad; ctx.fillRect(0,0,w,h/2);
                // Ch√£o
                ctx.fillStyle = '#111'; ctx.fillRect(0,h/2,w,h/2);
                
                // Estrada
                const cOffset = d.curve * 200;
                ctx.fillStyle = '#555';
                ctx.beginPath();
                ctx.moveTo(cx+cOffset-10, h*0.4); ctx.lineTo(cx+cOffset+10, h*0.4);
                ctx.lineTo(cx+w, h); ctx.lineTo(cx-w, h);
                ctx.fill();

                // Carro
                Gfx.drawFerrari(ctx, cx, h-80, d.smoothSteer * 0.5);

                return Math.floor(d.road/100);
            }
        },

        // --- JOGO 2: CORRIDA (Corre√ß√£o de Espelhamento) ---
        Run: {
            lane: 0, score: 0, obs: [], frame: 0,
            init: () => { Logic.Run.lane=0; Logic.Run.score=0; Logic.Run.obs=[]; System.msg("CORRA!"); },
            update: (ctx, w, h, pose) => {
                const r = Logic.Run;
                r.frame++;
                const cx = w/2;

                // 1. INPUT (L√ìGICA ESPELHO)
                // C√¢mera Raw: 0 (Esq) -> 640 (Dir).
                // Tela Espelhada: Minha Esquerda F√≠sica √© a Esquerda da Tela (que √© a Direita da C√¢mera Raw).
                // Esquerda F√≠sica = Nariz Raw X > 400
                // Direita F√≠sica = Nariz Raw X < 240
                if(pose) {
                    const nose = pose.keypoints.find(k=>k.name==='nose');
                    if(nose) {
                        if(nose.x < 240) r.lane = 1; // Direita (Raw Esq)
                        else if(nose.x > 400) r.lane = -1; // Esquerda (Raw Dir)
                        else r.lane = 0;
                    }
                }

                if(r.frame%50===0) r.obs.push({l: Math.floor(Math.random()*3)-1, z: 1000});

                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = '#002000'; ctx.fillRect(0,0,w,h);

                // Grid
                ctx.strokeStyle='#0f0'; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(cx-120, h/2); ctx.lineTo(0,h); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx+120, h/2); ctx.lineTo(w,h); ctx.stroke();

                r.obs.forEach((o, i) => {
                    o.z -= 25;
                    if(o.z < -100) { r.obs.splice(i,1); r.score+=10; Sfx.coin(); }
                    
                    const s = 500/(o.z+100);
                    if(s>0) {
                        const ox = cx + (o.l * 200 * s);
                        const oy = h/2 + (50 * s);
                        const sz = 80 * s;
                        
                        ctx.fillStyle = '#ff6600';
                        ctx.fillRect(ox-sz/2, oy, sz, sz);

                        // Colis√£o
                        if(o.z < 50 && o.z > -50 && o.l === r.lane) {
                            System.gameOver(r.score);
                        }
                    }
                });

                Gfx.drawRunner(ctx, cx + (r.lane*150), h-100, r.frame);
                return r.score;
            }
        },

        // --- JOGO 3: LUTA (Com Esqueleto) ---
        Fight: {
            targets: [], score: 0, last: 0,
            init: () => { Logic.Fight.targets=[]; Logic.Fight.score=0; System.msg("BOXE!"); },
            update: (ctx, w, h, pose) => {
                const f = Logic.Fight;
                const now = Date.now();

                ctx.clearRect(0,0,w,h);
                
                // 1. DESENHAR ESQUELETO (Visualiza√ß√£o Crucial)
                Gfx.drawSkeleton(ctx, pose, w, h);

                // 2. SPAWN DE ALVOS
                if(now - f.last > 900) {
                    f.targets.push({x: Math.random()*(w-100)+50, y: Math.random()*(h/2)+50, r: 50, s: now});
                    f.last = now;
                    Sfx.whoosh();
                }

                // 3. DETEC√á√ÉO DE HIT
                if(pose) {
                    const hands = [pose.keypoints.find(k=>k.name==='left_wrist'), pose.keypoints.find(k=>k.name==='right_wrist')];
                    // Fun√ß√£o Map para alinhar coordenada do v√≠deo com a tela
                    const mapX = x => w - (x / 640 * w);
                    const mapY = y => (y / 480 * h);

                    f.targets.forEach((t, i) => {
                        hands.forEach(hnd => {
                            if(hnd && hnd.score > 0.3) {
                                const hx = mapX(hnd.x);
                                const hy = mapY(hnd.y);
                                
                                // Se punho tocar na bolha
                                if(Math.hypot(hx-t.x, hy-t.y) < t.r) {
                                    f.targets.splice(i,1);
                                    f.score += 100;
                                    Sfx.hit();
                                    System.msg("POW!");
                                }
                            }
                        });
                    });
                }

                // 4. DESENHO ALVOS
                f.targets.forEach((t, i) => {
                    const age = (now - t.s)/1500;
                    if(age>1) f.targets.splice(i,1);
                    
                    ctx.beginPath(); ctx.arc(t.x, t.y, t.r*(1-age), 0, Math.PI*2);
                    ctx.fillStyle = `rgba(255, 0, 255, ${1-age})`; ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth=3; ctx.stroke();
                });

                return f.score;
            }
        }
    };
</script>
</body>
</html>
