<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>thIAguinho Wii: ULTIMATE EDITION</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Russo+One&display=swap');

        /* RESET GERAL */
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            font-family: 'Russo One', sans-serif;
            touch-action: none; /* Impede zoom/scroll no mobile */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

        /* V√çDEO ESPELHADO (Para sensa√ß√£o natural) */
        #webcam {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Espelhamento Visual */
            filter: brightness(0.6) contrast(1.2);
            z-index: 0;
        }
        #video-source { display: none; }

        /* CANVAS DO JOGO */
        #game-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        /* UI SCREENS */
        .ui-screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 50;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }
        .interactive { pointer-events: auto !important; }

        /* ESTILOS NINTENDO-LIKE */
        .n-badge {
            background: #e60012; color: white; padding: 4px 12px;
            border-radius: 4px; font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            margin-bottom: 1rem;
        }
        
        .game-card {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #333;
            transition: transform 0.1s, border-color 0.1s;
        }
        .game-card:active { transform: scale(0.95); border-color: #00ffff; }

        /* SLIDER CUSTOMIZADO */
        input[type=range] {
            -webkit-appearance: none; background: transparent; width: 100%;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px;
            border-radius: 50%; background: #00ffff; margin-top: -8px;
            box-shadow: 0 0 10px #00ffff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #555; border-radius: 2px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <video id="video-source" playsinline></video>
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="game-canvas"></canvas>

    <div id="screen-boot" class="ui-screen bg-black interactive">
        <span class="n-badge">SYSTEM READY</span>
        <h1 class="text-6xl md:text-8xl text-white font-black italic mb-2 text-center" style="text-shadow: 4px 4px 0 #00ffff;">
            thIAguinho<br><span class="text-cyan-400">Wii U</span>
        </h1>
        <p class="text-gray-400 text-sm mb-10 font-mono">MOTION ENGINE V3.0</p>
        
        <button onclick="System.boot()" class="bg-cyan-600 hover:bg-cyan-500 text-white text-xl py-4 px-12 rounded-full font-bold shadow-[0_0_30px_rgba(6,182,212,0.6)] animate-pulse transition-transform transform hover:scale-105">
            TOCAR PARA INICIAR
        </button>
        <div id="boot-error" class="text-red-500 mt-4 text-xs font-mono hidden bg-black/50 p-2 rounded"></div>
    </div>

    <div id="screen-loading" class="ui-screen bg-black/95 hidden">
        <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-white text-xl font-bold tracking-widest">CALIBRANDO SENSORES...</h2>
        <div class="text-xs text-gray-500 mt-2" id="load-status">Carregando Rede Neural...</div>
    </div>

    <div id="screen-menu" class="ui-screen bg-black/80 hidden interactive overflow-y-auto">
        <h2 class="text-4xl text-white font-black mb-8 italic drop-shadow-lg">ESCOLHA O JOGO</h2>
        
        <div class="grid grid-cols-1 gap-4 w-full max-w-sm px-6 pb-10">
            <button onclick="System.launch('drive')" class="game-card p-5 rounded-xl flex items-center gap-4 group hover:bg-gray-800">
                <div class="text-4xl group-hover:scale-110 transition-transform">üèéÔ∏è</div>
                <div class="text-left">
                    <h3 class="text-xl text-white font-bold group-hover:text-red-400">SPEED RACER</h3>
                    <p class="text-xs text-gray-400">M√£os viram o volante.</p>
                </div>
            </button>

            <button onclick="System.launch('run')" class="game-card p-5 rounded-xl flex items-center gap-4 group hover:bg-gray-800">
                <div class="text-4xl group-hover:scale-110 transition-transform">üèÉ</div>
                <div class="text-left">
                    <h3 class="text-xl text-white font-bold group-hover:text-green-400">STREET RUN</h3>
                    <p class="text-xs text-gray-400">Corra e desvie (F√≠sica Real).</p>
                </div>
            </button>

            <button onclick="System.launch('fight')" class="game-card p-5 rounded-xl flex items-center gap-4 group hover:bg-gray-800">
                <div class="text-4xl group-hover:scale-110 transition-transform">ü•ä</div>
                <div class="text-left">
                    <h3 class="text-xl text-white font-bold group-hover:text-purple-400">PRO BOXING</h3>
                    <p class="text-xs text-gray-400">Esqueleto segue voc√™.</p>
                </div>
            </button>
        </div>
        
        <div class="fixed bottom-4 text-center w-full opacity-50">
            <p class="text-[10px] text-cyan-400 font-mono">Desenvolvido com ü§ñ por thIAguinho Solu√ß√µes</p>
        </div>
    </div>

    <div id="screen-hud" class="ui-screen hidden justify-between p-4 pointer-events-none">
        <div class="w-full flex justify-between items-start">
            <div class="bg-black/60 backdrop-blur px-6 py-2 rounded-full border border-white/10">
                <div class="text-[10px] text-cyan-400 font-bold tracking-widest">SCORE</div>
                <div id="hud-score" class="text-3xl text-white font-mono">00000</div>
            </div>
            <button onclick="System.quit()" class="interactive bg-red-600 text-white w-10 h-10 rounded-full font-bold shadow-lg border-2 border-white/20">X</button>
        </div>

        <div id="game-msg" class="absolute top-1/4 w-full text-center"></div>

        <div id="wheel-feedback" class="absolute bottom-20 left-1/2 transform -translate-x-1/2 hidden opacity-80">
            <div class="w-32 h-32 rounded-full border-4 border-cyan-400 flex items-center justify-center relative" id="virtual-wheel">
                <div class="w-full h-1 bg-cyan-400"></div> <div class="absolute top-0 w-1 h-4 bg-red-500"></div> </div>
            <p class="text-center text-xs text-cyan-400 mt-2 font-mono">INPUT VIRTUAL</p>
        </div>

        <div class="interactive absolute bottom-6 right-6 bg-black/60 p-3 rounded-lg backdrop-blur border border-white/10">
            <label class="text-[10px] text-gray-300 block mb-1 text-center font-bold">SENSIBILIDADE</label>
            <input type="range" min="0.5" max="3.0" step="0.5" value="1.0" class="w-32 accent-cyan-400" oninput="System.setSens(this.value)">
        </div>
    </div>

    <div id="screen-over" class="ui-screen bg-red-900/95 hidden interactive z-50">
        <h1 class="text-6xl text-white font-black italic mb-2">GAME OVER</h1>
        <div class="text-6xl text-yellow-400 font-mono font-bold mb-8" id="final-score">0</div>
        <button onclick="System.menu()" class="bg-white text-red-900 py-3 px-10 rounded-full font-bold hover:scale-105 transition-transform shadow-xl">
            MENU PRINCIPAL
        </button>
    </div>
</div>

<script>
    /**
     * =================================================================
     * üîä AUDIO ENGINE (Sintetizador Puro)
     * =================================================================
     */
    const Sfx = {
        ctx: null,
        init: () => {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            Sfx.ctx = new AudioContext();
        },
        tone: (freq, type, dur, vol=0.1) => {
            if(!Sfx.ctx) return;
            const osc = Sfx.ctx.createOscillator();
            const gain = Sfx.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, Sfx.ctx.currentTime);
            gain.gain.setValueAtTime(vol, Sfx.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, Sfx.ctx.currentTime + dur);
            osc.connect(gain);
            gain.connect(Sfx.ctx.destination);
            osc.start();
            osc.stop(Sfx.ctx.currentTime + dur);
        },
        coin: () => { Sfx.tone(1200, 'sine', 0.1); setTimeout(()=>Sfx.tone(1600, 'sine', 0.2), 50); },
        crash: () => { Sfx.tone(100, 'sawtooth', 0.4, 0.3); },
        engine: (speed) => { /* Placeholder para som de motor complexo */ }
    };

    /**
     * =================================================================
     * üé® GRAPHICS & SKELETON (Visual Polish)
     * =================================================================
     */
    const Gfx = {
        drawSkeleton: (ctx, pose, w, h) => {
            if(!pose) return;
            const p = pose.keypoints;
            const find = n => p.find(k=>k.name===n);
            
            // Pontos Chave
            const joints = ['nose', 'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow', 'left_wrist', 'right_wrist'];
            const connections = [
                ['left_shoulder', 'right_shoulder'],
                ['left_shoulder', 'left_elbow'], ['left_elbow', 'left_wrist'],
                ['right_shoulder', 'right_elbow'], ['right_elbow', 'right_wrist'],
                ['nose', 'left_shoulder'], ['nose', 'right_shoulder'] // Pesco√ßo abstrato
            ];

            // Fun√ß√£o de Mapeamento (Video -> Tela Espelhada)
            // Video: 640x480. Tela: WxH. Espelhado horizontalmente.
            const mapX = x => w - (x / 640 * w); 
            const mapY = y => (y / 480 * h);

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Desenhar Ossos
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 6;
            connections.forEach(pair => {
                const p1 = find(pair[0]);
                const p2 = find(pair[1]);
                if(p1 && p2 && p1.score > 0.3 && p2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(mapX(p1.x), mapY(p1.y));
                    ctx.lineTo(mapX(p2.x), mapY(p2.y));
                    ctx.stroke();
                }
            });

            // Desenhar Juntas
            ctx.fillStyle = '#fff';
            joints.forEach(name => {
                const pt = find(name);
                if(pt && pt.score > 0.3) {
                    ctx.beginPath();
                    ctx.arc(mapX(pt.x), mapY(pt.y), 6, 0, Math.PI*2);
                    ctx.fill();
                }
            });
        },

        drawFerrari: (ctx, x, y, angle) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(1.5, 1.5);
            ctx.rotate(angle);
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.beginPath(); ctx.ellipse(0, 5, 40, 20, 0, 0, Math.PI*2); ctx.fill();
            // Chassi
            ctx.fillStyle = '#d00'; // Rosso Corsa
            ctx.beginPath();
            ctx.moveTo(-30, 15); ctx.lineTo(-25, -10);
            ctx.quadraticCurveTo(0, -15, 25, -10);
            ctx.lineTo(30, 15); ctx.closePath(); ctx.fill();
            // Spoiler
            ctx.fillStyle = '#900'; ctx.fillRect(-28, 12, 56, 5);
            // Vidro
            ctx.fillStyle = '#222'; ctx.beginPath(); ctx.moveTo(-20,-5); ctx.lineTo(-15,-15); ctx.lineTo(15,-15); ctx.lineTo(20,-5); ctx.fill();
            ctx.restore();
        },

        drawRunner: (ctx, x, y, frame) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(2, 2);
            ctx.strokeStyle = '#0f0'; ctx.lineWidth = 3; ctx.lineCap = 'round';
            const s = Math.sin(frame * 0.5) * 10;
            // Tronco
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(5, -20); ctx.stroke();
            // Pernas
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-10+s, 20); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(10-s, 20); ctx.stroke();
            // Bra√ßos
            ctx.beginPath(); ctx.moveTo(5,-18); ctx.lineTo(-10-s, -10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(5,-18); ctx.lineTo(15+s, -10); ctx.stroke();
            // Cabe√ßa
            ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(5, -25, 5, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }
    };

    /**
     * =================================================================
     * üß† SYSTEM CORE
     * =================================================================
     */
    const System = {
        video: document.getElementById('video-source'),
        canvas: document.getElementById('game-canvas'),
        ctx: document.getElementById('game-canvas').getContext('2d'),
        detector: null,
        active: false,
        mode: null,
        sens: 1.0,
        loopId: null,

        boot: async () => {
            document.getElementById('screen-boot').classList.add('hidden');
            document.getElementById('screen-loading').classList.remove('hidden');
            
            Sfx.init(); 
            Sfx.coin(); // Test audio

            try {
                // Camera
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: {ideal: 640}, height: {ideal: 480} },
                    audio: false
                });
                System.video.srcObject = stream;
                document.getElementById('webcam').srcObject = stream;
                await new Promise(r => System.video.onloadedmetadata = r);
                System.video.play();
                document.getElementById('webcam').play();

                // AI
                await tf.setBackend('webgl');
                System.detector = await poseDetection.createDetector(
                    poseDetection.SupportedModels.MoveNet,
                    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
                );

                document.getElementById('screen-loading').classList.add('hidden');
                System.menu();

            } catch(e) {
                document.getElementById('boot-error').innerText = "Erro: " + e.message;
                document.getElementById('boot-error').classList.remove('hidden');
                document.getElementById('screen-boot').classList.remove('hidden');
                document.getElementById('screen-loading').classList.add('hidden');
            }
        },

        launch: (m) => {
            System.mode = m;
            System.active = true;
            if(m === 'drive') Logic.Drive.init();
            if(m === 'run') Logic.Run.init();
            if(m === 'fight') Logic.Fight.init();

            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-hud').classList.remove('hidden');
            
            // Show wheel feedback only for drive
            if(m==='drive') document.getElementById('wheel-feedback').classList.remove('hidden');
            else document.getElementById('wheel-feedback').classList.add('hidden');

            System.loop();
        },

        menu: () => {
            document.getElementById('screen-hud').classList.add('hidden');
            document.getElementById('screen-over').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
            System.ctx.clearRect(0,0,System.canvas.width, System.canvas.height);
        },

        quit: () => {
            System.active = false;
            cancelAnimationFrame(System.loopId);
            System.menu();
        },

        setSens: (v) => { System.sens = parseFloat(v); },

        msg: (txt) => {
            const el = document.getElementById('game-msg');
            el.innerHTML = `<h1 class="text-4xl text-yellow-400 font-black drop-shadow-md animate-bounce">${txt}</h1>`;
            setTimeout(()=>el.innerHTML='', 1500);
        },

        gameOver: (score) => {
            System.active = false;
            cancelAnimationFrame(System.loopId);
            Sfx.crash();
            document.getElementById('final-score').innerText = score;
            document.getElementById('screen-hud').classList.add('hidden');
            document.getElementById('screen-over').classList.remove('hidden');
        },

        loop: async () => {
            if(!System.active) return;
            
            // Resize
            if(System.canvas.width !== window.innerWidth) {
                System.canvas.width = window.innerWidth;
                System.canvas.height = window.innerHeight;
            }

            const ctx = System.ctx;
            const w = System.canvas.width;
            const h = System.canvas.height;
            
            // AI Detection
            let pose = null;
            try {
                const poses = await System.detector.estimatePoses(System.video, {flipHorizontal: false});
                if(poses.length>0) pose = poses[0];
            } catch(e){}

            // Update Game
            let score = 0;
            if(System.mode === 'drive') score = Logic.Drive.update(ctx, w, h, pose);
            if(System.mode === 'run') score = Logic.Run.update(ctx, w, h, pose);
            if(System.mode === 'fight') score = Logic.Fight.update(ctx, w, h, pose);

            document.getElementById('hud-score').innerText = score.toString().padStart(5, '0');
            System.loopId = requestAnimationFrame(System.loop);
        }
    };

    /**
     * =================================================================
     * üéÆ GAME LOGIC (CORRIGIDA)
     * =================================================================
     */
    const Logic = {
        
        // --- CARRO (Corre√ß√£o de Dire√ß√£o & Sensibilidade) ---
        Drive: {
            x: 0, speed: 0, road: 0, curve: 0, steerSmooth: 0,
            init: () => { Logic.Drive.x=0; Logic.Drive.speed=0; System.msg("SEGURE O VOLANTE"); },
            update: (ctx, w, h, pose) => {
                const d = Logic.Drive;
                const cx = w/2;

                // 1. INPUT (Delta Y)
                let steerTarget = 0;
                if(pose) {
                    const lw = pose.keypoints.find(k=>k.name==='left_wrist');
                    const rw = pose.keypoints.find(k=>k.name==='right_wrist');
                    
                    if(lw.score > 0.3 && rw.score > 0.3) {
                        // Delta Y puro: Se M√£o Direita desce (Y aumenta) -> vira Direita (Positivo)
                        const dy = rw.y - lw.y; 
                        steerTarget = dy * 0.05 * System.sens; 

                        if(d.speed < 150) d.speed += 2;
                    } else {
                        if(d.speed > 0) d.speed -= 2;
                    }
                }

                // Suaviza√ß√£o (Lerp) para n√£o tremer
                d.steerSmooth += (steerTarget - d.steerSmooth) * 0.1;
                
                // Atualiza Volante Visual
                const wheel = document.getElementById('virtual-wheel');
                if(wheel) wheel.style.transform = `rotate(${d.steerSmooth * 20}deg)`;

                // F√≠sica
                d.road += d.speed;
                if(d.road > 2000) { d.tgtCurve = (Math.random()-0.5)*4; d.road=0; }
                d.curve += ((d.tgtCurve||0) - d.curve) * 0.02;

                d.x += d.steerSmooth * (d.speed/1000); // Input
                d.x -= d.curve * (d.speed/3000); // Centr√≠fuga

                if(Math.abs(d.x) > 1.2) { d.speed *= 0.9; } // Grama

                // Render
                ctx.clearRect(0,0,w,h);
                // C√©u
                let grad = ctx.createLinearGradient(0,0,0,h/2);
                grad.addColorStop(0, '#000033'); grad.addColorStop(1, '#660022');
                ctx.fillStyle = grad; ctx.fillRect(0,0,w,h/2);
                // Ch√£o
                ctx.fillStyle = '#111'; ctx.fillRect(0,h/2,w,h/2);
                
                // Estrada
                const curveOff = d.curve * 200;
                ctx.fillStyle = '#444';
                ctx.beginPath(); 
                ctx.moveTo(cx+curveOff-20, h*0.4); ctx.lineTo(cx+curveOff+20, h*0.4);
                ctx.lineTo(cx+w, h); ctx.lineTo(cx-w, h); 
                ctx.fill();

                // Carro
                Gfx.drawFerrari(ctx, cx, h-80, d.steerSmooth * 0.5);

                return Math.floor(d.road/100);
            }
        },

        // --- CORRIDA (L√≥gica Invertida para Espelho) ---
        Run: {
            lane: 0, score: 0, obs: [], frame: 0,
            init: () => { Logic.Run.lane=0; Logic.Run.score=0; Logic.Run.obs=[]; System.msg("CORRA!"); },
            update: (ctx, w, h, pose) => {
                const r = Logic.Run;
                r.frame++;
                const cx = w/2;

                // 1. INPUT (INVERTIDO!)
                // Camera raw: 0 (Esq) ... 640 (Dir).
                // Tela Espelhada: Minha Dir F√≠sica -> Tela Dir -> Camera Esq (0-200)
                if(pose) {
                    const nose = pose.keypoints.find(k=>k.name==='nose');
                    if(nose) {
                        // Se nariz est√° no pixel < 240 (Esq da camera)
                        // Significa que o usu√°rio foi para sua DIREITA f√≠sica.
                        // Lane 1 = Direita.
                        if(nose.x < 240) r.lane = 1; 
                        else if(nose.x > 400) r.lane = -1; // Esquerda f√≠sica
                        else r.lane = 0;
                    }
                }

                if(r.frame%40===0) r.obs.push({l: Math.floor(Math.random()*3)-1, z: 1000});

                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = '#002200'; ctx.fillRect(0,0,w,h);
                
                // Lanes
                ctx.strokeStyle = '#0f0'; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(cx-100, h/2); ctx.lineTo(0, h); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx+100, h/2); ctx.lineTo(w, h); ctx.stroke();

                r.obs.forEach((o, i) => {
                    o.z -= 25;
                    if(o.z < -100) { r.obs.splice(i,1); r.score+=10; }
                    const s = 500/(o.z+100);
                    if(s>0) {
                        const ox = cx + (o.l * 200 * s);
                        const oy = h/2 + (50 * s);
                        const size = 80 * s;
                        ctx.fillStyle = '#ff5500';
                        ctx.fillRect(ox-size/2, oy, size, size);

                        if(o.z < 50 && o.z > -50 && o.l === r.lane) {
                            System.gameOver(r.score);
                        }
                    }
                });

                // Player
                Gfx.drawRunner(ctx, cx + (r.lane*150), h-100, r.frame);

                return r.score;
            }
        },

        // --- LUTA (Com Esqueleto AR) ---
        Fight: {
            targets: [], score: 0, last: 0,
            init: () => { Logic.Fight.targets=[]; Logic.Fight.score=0; System.msg("BOXE!"); },
            update: (ctx, w, h, pose) => {
                const f = Logic.Fight;
                const now = Date.now();

                ctx.clearRect(0,0,w,h);

                // 1. DESENHAR ESQUELETO (Obrigat√≥rio)
                Gfx.drawSkeleton(ctx, pose, w, h);

                // 2. LOGICA
                if(now - f.last > 800) {
                    f.targets.push({x: Math.random()*(w-100)+50, y: Math.random()*(h/2)+50, r: 50, s: now});
                    f.last = now;
                }

                if(pose) {
                    const hands = [
                        pose.keypoints.find(k=>k.name==='left_wrist'),
                        pose.keypoints.find(k=>k.name==='right_wrist')
                    ];
                    
                    const mapX = x => w - (x / 640 * w);
                    const mapY = y => (y / 480 * h);

                    f.targets.forEach((t, i) => {
                        hands.forEach(hnd => {
                            if(hnd && hnd.score > 0.3) {
                                const hx = mapX(hnd.x);
                                const hy = mapY(hnd.y);
                                if(Math.hypot(hx-t.x, hy-t.y) < t.r) {
                                    f.targets.splice(i,1);
                                    f.score += 100;
                                    Sfx.coin();
                                    System.msg("HIT!");
                                }
                            }
                        });
                    });
                }

                f.targets.forEach((t, i) => {
                    const age = (now - t.s)/1500;
                    if(age>1) f.targets.splice(i,1);
                    ctx.beginPath(); ctx.arc(t.x, t.y, t.r*(1-age), 0, Math.PI*2);
                    ctx.fillStyle = `rgba(255,0,255,${1-age})`; ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.stroke();
                });

                return f.score;
            }
        }
    };
</script>
</body>
</html>
